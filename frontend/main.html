<!DOCTYPE html>
<html>
<head>
    <title>Agente WebRTC</title>
    <style>
        body { font-family: sans-serif; background-color: #f0f2f5; color: #1c1e21; margin: 0; padding: 20px; display: flex; flex-direction: column; align-items: center; }
        h1, h2 { color: #005c4b; }
        #status { font-weight: bold; margin-bottom: 20px; padding: 10px; border-radius: 5px; }
        .status-disconnected { color: #721c24; background-color: #f8d7da; }
        .status-connected { color: #155724; background-color: #d4edda; }
        .call-container { border: 1px solid #ddd; padding: 20px; margin-top: 20px; border-radius: 8px; background-color: #fff; box-shadow: 0 2px 4px rgba(0,0,0,0.1); width: 90%; max-width: 500px; }
        button { background-color: #00a884; color: white; border: none; padding: 10px 15px; border-radius: 25px; cursor: pointer; font-size: 16px; margin: 5px; transition: background-color 0.3s; }
        button:hover { background-color: #008069; }
        button:disabled { background-color: #ccc; cursor: not-allowed; }
        #incoming-call { display: none; }
        #on-call { display: none; }
        audio { margin-top: 15px; width: 100%; }
    </style>
</head>
<body>
    <h1>Panel de Agente</h1>
    <div id="status" class="status-disconnected">Estado: Desconectado</div>

    <div id="incoming-call" class="call-container">
        <h2>Llamada Entrante</h2>
        <p>De: <strong id="caller-name"></strong></p>
        <button id="answer-btn">Contestar</button>
    </div>

    <div id="on-call" class="call-container">
        <h2>En Llamada</h2>
        <p>Conectado con: <strong id="on-call-name"></strong></p>
        <audio id="audio" autoplay="true"></audio>
        <button id="hangup-btn">Colgar</button>
    </div>

    <script>
        const statusDiv = document.getElementById('status');
        const incomingCallDiv = document.getElementById('incoming-call');
        const onCallDiv = document.getElementById('on-call');
        const answerBtn = document.getElementById('answer-btn');
        const hangupBtn = document.getElementById('hangup-btn');
        const callerNameSpan = document.getElementById('caller-name');
        const onCallNameSpan = document.getElementById('on-call-name');
        const audioPlayer = document.getElementById('audio');

        let ws;
        let pc; // RTCPeerConnection
        let localStream; // MediaStream del micrófono
        let currentCallId = null;

        function connect() {
            // --- [SOLUCIÓN PARTE 1] ---
            // Detectar si la página es segura (https) y usar el protocolo WebSocket seguro (wss)
            const protocol = window.location.protocol === 'https:' ? 'wss:' : 'ws:';
const wsUrl = `${protocol}//${window.location.host}/ws`;
console.log(`Intentando conectar a: ${wsUrl}`);
            // --- FIN DE LA SOLUCIÓN ---

            ws = new WebSocket(wsUrl);

            ws.onopen = () => {
                console.log("Conectado al servidor WebSocket.");
                statusDiv.textContent = "Estado: Conectado al Lobby";
                statusDiv.className = 'status-connected';
            };

            ws.onmessage = async (event) => {
                const data = JSON.parse(event.data);
                console.log("Mensaje recibido:", data);

                switch (data.type) {
                    case 'incoming_call':
                        if (currentCallId) return; // Ya en una llamada o con una notificación
                        currentCallId = data.call_id;
                        callerNameSpan.textContent = data.from;
                        onCallNameSpan.textContent = data.from;
                        incomingCallDiv.style.display = 'block';
                        break;
                    
                    case 'offer_from_server':
                        await handleOfferFromServer(data.sdp);
                        break;

                    case 'call_terminated':
                        resetCallState();
                        break;
                }
            };

            ws.onclose = () => {
                console.log("Desconectado del servidor WebSocket. Intentando reconectar...");
                statusDiv.textContent = "Estado: Desconectado";
                statusDiv.className = 'status-disconnected';
                resetCallState();
                setTimeout(connect, 3000); // Reconectar cada 3 segundos
            };

            ws.onerror = (error) => {
                console.error("Error de WebSocket:", error);
                ws.close();
            };
        }

    answerBtn.onclick = async () => {
    incomingCallDiv.style.display = 'none';
    onCallDiv.style.display = 'block';
    
    // Solo enviar al servidor que queremos contestar
    // La captura del micrófono ocurrirá después
    ws.send(JSON.stringify({ type: 'answer_call', call_id: currentCallId }));
};

async function handleOfferFromServer(sdp) {
    try {
        // AHORA capturamos el micrófono, cuando recibimos la oferta
        if (!localStream) {
            localStream = await navigator.mediaDevices.getUserMedia({ 
                audio: true, 
                video: false 
            });
            console.log("Micrófono capturado después de recibir oferta del servidor.");
        }
    } catch (e) {
        console.error("Error al obtener acceso al micrófono:", e);
        alert("No se pudo acceder al micrófono. Por favor, revisa los permisos.");
        resetCallState();
        return;
    }

    // Crear la conexión
    pc = new RTCPeerConnection();

    pc.ontrack = (event) => {
        console.log("Pista de audio remota recibida del servidor.");
        if (audioPlayer.srcObject !== event.streams[0]) {
            audioPlayer.srcObject = event.streams[0];
        }
    };

    // AQUÍ agregamos el track del micrófono capturado
    localStream.getTracks().forEach(track => {
        console.log("Añadiendo pista de audio local a la conexión.");
        pc.addTrack(track, localStream);
    });

    // Completar la negociación
    await pc.setRemoteDescription({ type: 'offer', sdp: sdp });
    const answer = await pc.createAnswer();
    await pc.setLocalDescription(answer);

    ws.send(JSON.stringify({
        type: 'answer_from_browser',
        call_id: currentCallId,
        sdp: pc.localDescription.sdp
    }));
}




        hangupBtn.onclick = () => {
            ws.send(JSON.stringify({ type: 'hangup_from_browser', call_id: currentCallId }));
            resetCallState();
        };

        function resetCallState() {
            if (pc) {
                pc.close();
                pc = null;
            }
            if (localStream) {
                localStream.getTracks().forEach(track => track.stop());
                localStream = null;
            }
            incomingCallDiv.style.display = 'none';
            onCallDiv.style.display = 'none';
            currentCallId = null;
            audioPlayer.srcObject = null;
        }

        connect();
    </script>
</body>
</html>