<!DOCTYPE html>
<html>
<head>
    <title>Agente WebRTC</title>
    <style>
        body { font-family: sans-serif; background-color: #f0f2f5; color: #1c1e21; margin: 0; padding: 20px; display: flex; flex-direction: column; align-items: center; }
        h1, h2 { color: #005c4b; }
        #status { font-weight: bold; margin-bottom: 20px; padding: 10px; border-radius: 5px; }
        .status-disconnected { color: #721c24; background-color: #f8d7da; }
        .status-connected { color: #155724; background-color: #d4edda; }
        .call-container { border: 1px solid #ddd; padding: 20px; margin-top: 20px; border-radius: 8px; background-color: #fff; box-shadow: 0 2px 4px rgba(0,0,0,0.1); width: 90%; max-width: 500px; }
        button { background-color: #00a884; color: white; border: none; padding: 10px 15px; border-radius: 25px; cursor: pointer; font-size: 16px; margin: 5px; transition: background-color 0.3s; }
        button:hover { background-color: #008069; }
        button:disabled { background-color: #ccc; cursor: not-allowed; }
        #incoming-call { display: none; }
        #on-call { display: none; }
        audio { margin-top: 15px; width: 100%; }
        #debug-log { 
            margin-top: 20px; 
            padding: 10px; 
            background-color: #f5f5f5; 
            border: 1px solid #ddd; 
            border-radius: 5px; 
            max-height: 200px; 
            overflow-y: auto; 
            font-size: 12px;
            font-family: monospace;
            width: 90%;
            max-width: 500px;
        }
    </style>
</head>
<body>
    <h1>Panel de Agente</h1>
    <div id="status" class="status-disconnected">Estado: Desconectado</div>

    <div id="incoming-call" class="call-container">
        <h2>Llamada Entrante</h2>
        <p>De: <strong id="caller-name"></strong></p>
        <button id="answer-btn">Contestar</button>
    </div>

    <div id="on-call" class="call-container">
        <h2>En Llamada</h2>
        <p>Conectado con: <strong id="on-call-name"></strong></p>
        <audio id="audio" autoplay="true"></audio>
        <button id="hangup-btn">Colgar</button>
    </div>

    <div id="debug-log"></div>

    <script>
        const statusDiv = document.getElementById('status');
        const incomingCallDiv = document.getElementById('incoming-call');
        const onCallDiv = document.getElementById('on-call');
        const answerBtn = document.getElementById('answer-btn');
        const hangupBtn = document.getElementById('hangup-btn');
        const callerNameSpan = document.getElementById('caller-name');
        const onCallNameSpan = document.getElementById('on-call-name');
        const audioPlayer = document.getElementById('audio');
        const debugLog = document.getElementById('debug-log');

        let ws;
        let pc;
        let localStream;
        let currentCallId = null;

        function log(message) {
            console.log(message);
            debugLog.innerHTML += `${new Date().toLocaleTimeString()} - ${message}<br>`;
            debugLog.scrollTop = debugLog.scrollHeight;
        }

        function connect() {
            const protocol = window.location.protocol === 'https:' ? 'wss:' : 'ws:';
            const wsUrl = `${protocol}//${window.location.host}/ws`;
            log(`Intentando conectar a: ${wsUrl}`);

            ws = new WebSocket(wsUrl);

            ws.onopen = () => {
                log("âœ… Conectado al servidor WebSocket");
                statusDiv.textContent = "Estado: Conectado al Lobby";
                statusDiv.className = 'status-connected';
            };

            ws.onmessage = async (event) => {
                const data = JSON.parse(event.data);
                log(`ðŸ“© Mensaje recibido: ${data.type}`);

                switch (data.type) {
                    case 'incoming_call':
                        if (currentCallId) return;
                        currentCallId = data.call_id;
                        callerNameSpan.textContent = data.from;
                        onCallNameSpan.textContent = data.from;
                        incomingCallDiv.style.display = 'block';
                        log(`ðŸ“ž Llamada entrante de ${data.from}`);
                        break;
                    
                    case 'offer_from_server':
                        log(`ðŸ“¨ Recibida oferta del servidor`);
                        await handleOfferFromServer(data.sdp);
                        break;

                    case 'call_terminated':
                        log(`âŒ Llamada terminada`);
                        resetCallState();
                        break;
                }
            };

            ws.onclose = () => {
                log("ðŸ”Œ Desconectado del servidor. Reconectando en 3s...");
                statusDiv.textContent = "Estado: Desconectado";
                statusDiv.className = 'status-disconnected';
                resetCallState();
                setTimeout(connect, 3000);
            };

            ws.onerror = (error) => {
                log(`âŒ Error de WebSocket: ${error}`);
                ws.close();
            };
        }

        answerBtn.onclick = async () => {
            log(`ðŸŽ™ï¸ Contestando llamada...`);
            incomingCallDiv.style.display = 'none';
            
            // Capturar micrÃ³fono ANTES de contestar
            try {
                if (!localStream) {
                    log(`ðŸ”Š Solicitando acceso al micrÃ³fono...`);
                    localStream = await navigator.mediaDevices.getUserMedia({ 
                        audio: true, 
                        video: false 
                    });
                    log(`âœ… MicrÃ³fono capturado exitosamente`);
                }
            } catch (e) {
                log(`âŒ Error al capturar micrÃ³fono: ${e.message}`);
                alert("No se pudo acceder al micrÃ³fono. Por favor, revisa los permisos.");
                resetCallState();
                return;
            }

            // DESPUÃ‰S de capturar el micrÃ³fono, enviar answer_call
            log(`ðŸ“¤ Enviando answer_call al servidor...`);
            ws.send(JSON.stringify({ 
                type: 'answer_call', 
                call_id: currentCallId 
            }));
        };

        async function handleOfferFromServer(sdp) {
            try {
                log(`ðŸ”— Creando RTCPeerConnection...`);
                pc = new RTCPeerConnection();

                // Event: cuando recibimos audio remoto (de WhatsApp)
                pc.ontrack = (event) => {
                    log(`ðŸŽµ Recibida pista de audio remota`);
                    if (audioPlayer.srcObject !== event.streams[0]) {
                        audioPlayer.srcObject = event.streams[0];
                        log(`âœ… Audio remoto conectado al player`);
                    }
                };

                // Event: cambios en la conexiÃ³n
                pc.onconnectionstatechange = () => {
                    log(`ðŸ”Œ Estado conexiÃ³n: ${pc.connectionState}`);
                };

                pc.oniceconnectionstatechange = () => {
                    log(`â„ï¸ Estado ICE: ${pc.iceConnectionState}`);
                };

                // CRÃTICO: Agregar el stream local ANTES de setRemoteDescription
                if (localStream) {
                    log(`âž• Agregando pistas de audio local a la conexiÃ³n...`);
                    localStream.getTracks().forEach((track, index) => {
                        log(`  â”œâ”€ Agregando track ${index}: ${track.kind}`);
                        pc.addTrack(track, localStream);
                    });
                    log(`âœ… Todas las pistas locales agregadas`);
                } else {
                    log(`âŒ CRÃTICO: localStream es null!`);
                }

                // Ahora sÃ­ procesar la oferta
                log(`ðŸ“ Procesando oferta remota...`);
                await pc.setRemoteDescription({ type: 'offer', sdp: sdp });
                log(`âœ… Oferta remota procesada`);

                log(`ðŸ¤ Creando answer...`);
                const answer = await pc.createAnswer();
                await pc.setLocalDescription(answer);
                log(`âœ… Answer creado y configurado`);

                log(`ðŸ“¤ Enviando answer al servidor...`);
                ws.send(JSON.stringify({
                    type: 'answer_from_browser',
                    call_id: currentCallId,
                    sdp: pc.localDescription.sdp
                }));

                onCallDiv.style.display = 'block';
                log(`ðŸ“ž Conectado en la llamada`);

            } catch (error) {
                log(`âŒ Error en handleOfferFromServer: ${error.message}`);
                console.error(error);
                resetCallState();
            }
        }

        hangupBtn.onclick = () => {
            log(`â˜Žï¸ Colgando llamada...`);
            ws.send(JSON.stringify({ 
                type: 'hangup_from_browser', 
                call_id: currentCallId 
            }));
            resetCallState();
        };

        function resetCallState() {
            if (pc) {
                pc.close();
                pc = null;
            }
            if (localStream) {
                localStream.getTracks().forEach(track => track.stop());
                localStream = null;
            }
            incomingCallDiv.style.display = 'none';
            onCallDiv.style.display = 'none';
            currentCallId = null;
            audioPlayer.srcObject = null;
            log(`ðŸ”„ Estado de llamada reiniciado`);
        }

        log(`ðŸš€ Inicializando agente...`);
        connect();
    </script>
</body>
</html>